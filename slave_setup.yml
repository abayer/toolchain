---
- hosts: jenkins-slaves
  vars:
    maven_url: "http://mirror.nexcess.net/apache/maven/maven-3/3.2.1/binaries/apache-maven-3.2.1-bin.tar.gz"
    ant_url: "http://www.dsgnwrld.com/am//ant/binaries/apache-ant-1.9.4-bin.tar.gz"
    j_home: "/home/jenkins"
    t_home: /home/jenkins/tools
    m_home: /home/jenkins/tools/maven
    a_home: /home/jenkins/tools/ant

  tasks:
    - name: "Setup jenkins user"
      sudo: yes
      sudo_user: root
      user: name="jenkins" comment="Jenkins Slave" shell="/bin/bash"

    - name: "Setup Tools Dir"
      sudo: yes
      sudo_user: jenkins
      file: path={{t_home}} state=directory owner=jenkins
      file: path={{t_home}}/ant state=directory owner=jenkins
      file: path={{t_home}}/maven state=directory owner=jenkins

    - name: "Download Maven"
      sudo: yes
      sudo_user: jenkins
      get_url: url={{maven_url}} dest={{t_home}}/maven/maven.tar.gz mode=0744

    - name: "Download Ant"
      sudo: yes
      sudo_user: jenkins
      get_url: url={{ant_url}} dest={{t_home}}/ant/ant.tar.gz mode=0744

    - name: "Untar Maven"
      sudo: yes
      sudo_user: jenkins
      unarchive: copy=no src={{t_home}}/maven/maven.tar.gz dest={{t_home}}/maven

    - name: "Untar Ant"
      sudo: yes
      sudo_user: jenkins
      unarchive: copy=no src={{t_home}}/ant/ant.tar.gz dest={{t_home}}/ant

    - name: "symlink Maven -> latest"
      sudo: yes
      sudo_user: jenkins
      file: src=apache-maven-3.2.1 dest={{t_home}}/maven/latest state=link

    - name: "symlink Ant -> latest"
      sudo: yes
      sudo_user: jenkins
      file: src=apache-ant-1.9.4 dest={{t_home}}/ant/latest state=link

    - name: "cleanup archives"
      sudo: yes
      sudo_user: jenkins
      file: path={{t_home}}/{{item}} state=absent
      with_items:
        - ant/ant.tar.gz
        - maven/maven.tar.gz

    - name: "copy env file"
      sudo: yes
      sudo_user: jenkins
      copy: src=files/jenkins_env.sh dest={{t_home}}/env.sh mode=755

    - name: "Installing Libraries"
      sudo: yes
      sudo_user: root
      apt: pkg={{item}} update_cache=yes state=latest
      with_items:
        - libsnappy-dev
        - libcppunit-dev
        - liblzo2-dev
        - protobuf-compiler


